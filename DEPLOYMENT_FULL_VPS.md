# المرجع التقني الشامل لنظام Moonlight Noexis

هذا المستند هو دليلك الكامل لإدارة النظام وتشغيله وتعديله على السيرفر الخاص بك.

## 1. فهم البنية التحتية (Architecture)

النظام يعمل داخل حاويات Docker معزولة تتحدث مع بعضها البعض عبر شبكة داخلية، ويتم توحيد الوصول إليها عبر بوابة (Gateway).

*   **المستخدم (أنت)** يتصل بـ -> **IP السيرفر**.
*   **المنفذ 80 (Nginx):** يخدم تطبيق الويب (React Frontend).
*   **المنفذ 8000 (Kong Gateway):** هو "المدخل الموحد" للخدمات الخلفية (API).
    *   `/rest/v1/` -> يذهب لخدمة البيانات (PostgREST).
    *   `/auth/v1/` -> يذهب لخدمة المصادقة (GoTrue).
    *   `/realtime/v1/` -> يذهب لخدمة التزامن الحي.
*   **المنفذ 5432 (Postgres):** قاعدة البيانات (مخزن المعلومات).
*   **المنفذ 3000 (Studio):** لوحة تحكم مرئية لإدارة قاعدة البيانات.

## 2. الإعدادات والمفاتيح (Configuration & Keys)

القلب النابض لإعدادات النظام هو ملف `.env`.

### كيفية توليد مفاتيح أمان جديدة (JWT)
لأمان النظام، يجب أن تكون مفاتيح التشفير خاصة بك وحدك.
1.  انتقل لموقع مثل [JWT.io](https://jwt.io/) أو استخدم الأمر التالي في التيرمينال لإنشاء مفتاح سري عشوائي:
    ```bash
    openssl rand -hex 32
    ```
    هذا هو `JWT_SECRET` الخاص بك.

2.  **توليد التوكنات (Tokens):**
    تحتاج لإنشاء مفتاحين مشتقين من الـ Secret الذي صنعته:
    *   `ANON_KEY`: للمستخدمين العاديين (صلاحيات محدودة).
    *   `SERVICE_ROLE_KEY`: للسيرفر (صلاحيات كاملة - خطر!).

    يمكنك استخدام [أداة Supabase JWT المحلية](https://supabase.com/docs/guides/self-hosting/docker#generate-api-keys) أو سكربت بايثون بسيط لتوليدها باستخدام الـ Secret الخاص بك.

3.  **تحديث الملف:**
    افتح ملف `.env` وضع المفاتيح الجديدة:
    ```bash
    nano .env
    ```
    ثم اضغط `Ctrl+X` ثم `Y` للحفظ.

## 3. إدارة قاعدة البيانات (Database)

### الوصول عبر لوحة التحكم (Studio)
أسهل طريقة.
*   الرابط: `http://185.225.233.103:3000`
*   يمكنك من هنا: رؤية الجداول، تعديل البيانات يدوياً، تشغيل استعلامات SQL.

### الوصول عبر سطر الأوامر (للمحترفين)
إذا أردت تنفيذ أوامر مباشرة على القاعدة:
```bash
docker exec -it supabase-db psql -U postgres
```
الآن أنت داخل قاعدة البيانات. جرب:
```sql
\dt          -- عرض الجداول
select * from users; -- عرض المستخدمين
```

### النسخ الاحتياطي (Backup)
لضمان عدم ضياع البيانات، خذ نسخة احتياطية دورية:
```bash
# إنشاء مجلد للنسخ الاحتياطية
mkdir -p ~/backups

# أخذ النسخة (مع التاريخ والوقت)
docker exec supabase-db pg_dumpall -U postgres > ~/backups/backup_$(date +%Y%m%d_%H%M%S).sql
```

## 4. استكشاف الأخطاء وإصلاحها (Troubleshooting)

### النظام لا يعمل أو توقف فجأة
1.  تحقق من حالة الحاويات:
    ```bash
    docker-compose ps
    ```
    يجب أن تكون الحالة `Up`. إذا وجدت `Exit` أو `Restarting`، فهناك مشكلة.

2.  اقرأ السجلات (Logs) لتعرف السبب:
    ```bash
    docker-compose logs -f
    ```
    أو لخدمة معينة (مثلاً قاعدة البيانات):
    ```bash
    docker-compose logs -f db
    ```

### تعديل الـ API Gateway
إذا أردت إضافة خدمة جديدة أو تغيير مسار، الملف المسؤول هو:
`volumes/api/kong.yml`
بعد تعديله، يجب إعادة تشغيل حاوية Kong:
```bash
docker-compose restart kong
```

## 5. التحديث المستمر

عندما نقوم بتعديل الكود البرمجي (React) ونرفعه للسيرفر:
1.  اسحب التغييرات (git pull) أو ارفع الملفات الجديدة.
2.  أعد البناء:
    ```bash
    docker-compose up -d --build app
    ```
    (لاحظ أننا حددنا `app` فقط لإعادة بناء الواجهة دون إعادة تشغيل قاعدة البيانات).

---
**بيانات الاتصال الحالية:**
*   **IP:** 185.225.233.103
*   **App URL:** http://185.225.233.103
*   **DB Password:** (موجودة في ملف .env)
